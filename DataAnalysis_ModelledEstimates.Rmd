---
title: "AntigenPaper_Prevalence"
author: "Kat Holt"
date: "2025-03-04"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = getwd())

library(ggplot2)
library(tidyverse)
library(dplyr)
library(patchwork)
library(reshape2)
library(RColorBrewer)
library(ggridges)
library(logistf)
#library(meta)
#library(ggpol) # used by pyramid plot function
```

# Setup

## load sero-epi functions
``` {r}

source("seroepi_functions.R")
source("https://raw.githubusercontent.com/klebgenomics/KleborateR/main/kleborate_functions.R")
source("https://raw.githubusercontent.com/klebgenomics/KleborateR/main/plotting_functions.R")

#source("~/Documents/GitHub/KleborateR/kleborate_functions.R")
#source("~/Documents/GitHub/KleborateR/plotting_functions.R")

```

## set colour palettes
``` {r}
# source: https://davidmathlogic.com/colorblind/#%23D81B60-%231E88E5-%23FFC107-%23004D40
  
region_cols <- c(`Southern Asia` ="#D81B60", `Western Africa`="#1E88E5", `Eastern Africa`="#FFC107", `Southern Africa`="#81B1A9", Global="black")

group_cols <- c(All="black", Fatal ="#D81B60", ESBL="#1E88E5", CP="#FFC107")
```

## load underlying sample data
``` {r}

#data_NNS_sites10 <- read_csv("inputs_paper/Neonatal_shareable_20241002_28_filterN10.csv")
data_NNS_sites10 <- read_tsv("tables/TableS3_IsolatesIncluded_NEEDSACCESSIONS.tsv")

dim(data_NNS_sites10)

table(data_NNS_sites10$Study)

dir.create("tables")
dir.create("figures")

```


# K locus analysis

## read posterior estimates for adjusted counts (main) and raw counts (for comparison)
``` {r}

# read adjusted Bayesian estimates for K
kbayes <- parseModelledEstimates(global_post="outputs_paper/K_Full_min10_adj_28_posterior_global.csv.gz", region_post="outputs_paper/K_Full_min10_adj_28_posterior_subgroup.csv.gz")

# read raw Bayesian estimates for K
kbayes_raw <- parseModelledEstimates(global_post="outputs_paper/K_Full_min10_raw_28_posterior_global.csv.gz", region_post="outputs_paper/K_Full_min10_raw_28_posterior_subgroup.csv.gz")

```

## global and regional prevalence
``` {r}
k_prev_global_bar <- locus_barplot(estimates=kbayes$global_est %>% filter(grepl("KL",locus)), 
                                   ranks=kbayes$locus_rank, 
                                   lines_every=10, error_bars=T, median=F)

k_prev_global_dist <- locus_ridgesplot(posterior=kbayes$global_post,
                                   ranks=kbayes$locus_rank, 
                                   lines_every=10, 
                                   xlim=c(0,12), xbreaks=seq(0,12,1), scale=1.5,
                                   title = "a) Global estimates")

k_prev_region_heatmap <- region_heatmap(kbayes$region_est, kbayes$global_est, 
                                   ranks=kbayes$locus_rank, median=F, title="b) Point estimates")

k_prev_global_bar + k_prev_region_heatmap

```

``` {r}
# fig 2
k_prev_global_dist + k_prev_region_heatmap

ggsave("figures/Fig2_K_global_regional_Kadj.pdf", width=8, height=6)
ggsave("figures/Fig2_K_global_regional_Kadj.png", width=8, height=6)
```



# global modelled prevalence
``` {r}
k_prev_global_dist_all <- locus_ridgesplot(posterior=kbayes$global_post,
                                   ranks=kbayes$locus_rank,
                                   maxRank = 90, axis_font_size=8,
                                   lines_every=10, 
                                   xlim=c(0,12), xbreaks=seq(0,12,1), scale=3, title="a) Global estimates")

k_prev_region_heatmap_all <- region_heatmap(kbayes$region_est, kbayes$global_est,
                                   ranks=kbayes$locus_rank,
                                   maxRank = 90, axis_font_size=8, median=F, title="b) Point estimates")

```


``` {r}
k_prev_global_dist_all + k_prev_region_heatmap_all
ggsave("figures/FigS4_K_global_regional_Kadj.pdf", width=8, height=10)
ggsave("figures/FigS4_K_global_regional_Kadj.png", width=8, height=10)
```




## compare global prevalence distributions using cluster-adjusted and raw counts
``` {r}
# plot raw vs adjusted distributions
k_prev_global_dist_raw <- locus_ridgesplot(posterior=kbayes_raw$global_post, ranks=kbayes_raw$locus_rank, lines_every=10, xlim=c(0,15), xbreaks=seq(0,15,1), col="skyblue", title="b) Global prevalence (raw)")

k_prev_global_dist + k_prev_global_dist_raw

# or plot together overlaid - for fig S14b
k_dist_raw_adj <- comparative_locus_ridgesplot(posterior1=kbayes$global_post,
                             posterior2=kbayes_raw$global_post,
                             ranks=kbayes$locus_rank, 
                             lines_every=10, xlim=c(0,20), xbreaks=seq(0,20,1))
```

# logistic regression of K vs year + region
``` {r}
result <- c()
for (k in kbayes$locus_rank$locus[1:30]) {
  d <- data_NNS_sites10 %>%
    mutate(k=if_else(K_locus==k, 1, 0)) %>%
    select(k, Year, Region)
  m <- summary(logistf(k~Year+Region, data=d))
  result <- rbind(result, cbind(coef=m$coefficients, p=m$prob, locus=k))
}

logistic_sig <- as_tibble(result, rownames="variable") %>% filter(p<0.05) %>% left_join(kbayes$locus_rank)
```

``` {r}
p<-0.02

region_2pc <- kbayes$region_est %>% select(locus, subgroup, mean) %>% 
  pivot_wider(id_cols=locus, names_from=subgroup, values_from = mean) %>% 
  mutate(d1=abs(`Eastern Africa`-`Southern Africa`),
        d2=abs(`Eastern Africa`-`Western Africa`),
        d3=abs(`Eastern Africa`-`Southern Asia`),
        d4=abs(`Southern Africa`-`Southern Asia`),
        d5=abs(`Southern Africa`-`Western Africa`),
        d6=abs(`Western Africa`-`Southern Asia`)) %>% 
  filter(d1>p | d2>p | d3>p | d4>p | d5>p | d6>p)
```

# overlapping regional densities
``` {r}
kbayes$region_post %>% 
    left_join(kbayes$locus_rank) %>%
    filter(rank<=30) %>%
    mutate(Region=fct_relevel(subgroup,c("Western Africa", "Southern Africa", "Eastern Africa", "Southern Asia"))) %>%
    ggplot() +
    geom_hline(yintercept=11) +
    geom_hline(yintercept=21) +
    geom_density_ridges(aes(x=prob*100, y=locus, fill=Region), 
                        scale=1, rel_min_height = 0.01, alpha=0.5, col=NA) + 
    scale_y_discrete(limits=rev(kbayes$locus_rank$locus[1:30])) + 
  scale_x_continuous(limits=c(0,30)) +
  labs(x="Prevalence per region", y="", fill="Region") + 
  annotate(y=region_2pc$locus, label="*", x=29, geom="text") + 
  annotate(y=logistic_sig$locus, label="^", x=30, geom="text") +
  scale_fill_manual(values=region_cols) +
  theme_bw()
```

# overlapping regional densities - log2 scale
``` {r}
kbayes$region_post %>% 
    left_join(kbayes$locus_rank) %>%
    filter(rank<=30) %>%
    mutate(Region=fct_relevel(subgroup,c("Western Africa", "Southern Africa", "Eastern Africa", "Southern Asia"))) %>%
    ggplot() +
    geom_hline(yintercept=11) +
    geom_hline(yintercept=21) +
    geom_density_ridges(aes(x=log2(prob), y=locus, fill=Region), 
                        scale=1, rel_min_height = 0.01, alpha=0.5, col=NA) + 
    scale_y_discrete(limits=rev(kbayes$locus_rank$locus[1:30])) + 
  scale_x_continuous(limits=c(-13,0)) +
  labs(x="log2(prevalence) per region", y="", fill="Region") + 
  annotate(y=region_2pc$locus, label="*", x=-1, geom="text") + 
  annotate(y=logistic_sig$locus, label="^", x=-0.5, geom="text") +
  scale_fill_manual(values=region_cols) +
  theme_bw()
```

``` {r}
ggsave("figures/FigS5_RegionalKBayesDist.pdf", width=6, height=9)
ggsave("figures/FigS5_RegionalKBayesDist.png", width=6, height=9)
```


# O locus analysis

## read posterior estimates for adjusted counts (main) and raw counts (for comparison)
``` {r}

# read adjusted Bayesian estimates for O
obayes <- parseModelledEstimates(global_post ="outputs_paper/O_Full_min10_adj_28_posterior_global.csv.gz", region_post = "outputs_paper/O_Full_min10_adj_28_posterior_subgroup.csv.gz", fixOnames = T)

# read raw Bayesian estimates for O
obayes_raw <- parseModelledEstimates(global_post ="outputs_paper/O_Full_min10_raw_28_posterior_global.csv.gz", region_post = "outputs_paper/O_Full_min10_raw_28_posterior_subgroup.csv.gz", fixOnames = T)

```

## global and regional prevalence
``` {r}
o_prev_global_bar <- locus_barplot(estimates=obayes$global_est, 
                                   ranks=obayes$locus_rank, 
                                   lines_every=5, maxRank=15, error_bars=T, median=F)

o_prev_global_dist <- locus_ridgesplot(posterior=obayes$global_post, 
                                   ranks=obayes$locus_rank, 
                                   lines_every=5, maxRank=15, 
                                   xlim=c(0,30), xbreaks=seq(0,30,5), title="a) Global estimates")

o_prev_region_heatmap <- region_heatmap(estimates=obayes$region_est, global=obayes$global_est,
                                   ranks=obayes$locus_rank, maxRank=15, median=F, title="b) Point estimates")

o_prev_global_bar + o_prev_region_heatmap


```

``` {r}
# fig 4a
o_prev_global_dist + o_prev_region_heatmap

```


## compare global prevalence distributions using cluster-adjusted and raw counts
``` {r}
# plot raw vs adjusted distributions
o_prev_global_dist_raw <- locus_ridgesplot(posterior=obayes_raw$global_post, 
                                   ranks=obayes$locus_rank, 
                                   maxRank=15, lines_every=5, 
                                   xlim=c(0,30), xbreaks=seq(0,30,5), 
                                   col="skyblue", 
                                   title="b) Global prevalence (raw)")

o_prev_global_dist + o_prev_global_dist_raw

# or plot together overlaid - for fig S14b
o_dist_raw_adj <- comparative_locus_ridgesplot(posterior1=obayes$global_post,
                             posterior2=obayes_raw$global_post,
                             ranks=obayes$locus_rank, maxRank=10,
                             lines_every=5, xlim=c(0,30), xbreaks=seq(0,30,5))
```

# logistic regression of O vs year + region
``` {r}
oresult <- c()
for (o in obayes$locus_rank$locus[1:10]) {
  d <- data_NNS_sites10 %>%
    mutate(o=if_else(O_genotype==o, 1, 0)) %>%
    select(o, Year, Region)
  m <- summary(logistf(o~Year+Region, data=d))
  oresult <- rbind(oresult, cbind(coef=m$coefficients, p=m$prob, locus=o))
}

logistic_sig_o <- as_tibble(oresult, rownames="variable") %>% filter(p<0.05) %>% left_join(obayes$locus_rank)
```

``` {r}
p<-0.05

region_5pc_o <- obayes$region_est %>% select(locus, subgroup, mean) %>% 
  pivot_wider(id_cols=locus, names_from=subgroup, values_from = mean) %>% 
  mutate(d1=abs(`Eastern Africa`-`Southern Africa`),
        d2=abs(`Eastern Africa`-`Western Africa`),
        d3=abs(`Eastern Africa`-`Southern Asia`),
        d4=abs(`Southern Africa`-`Southern Asia`),
        d5=abs(`Southern Africa`-`Western Africa`),
        d6=abs(`Western Africa`-`Southern Asia`)) %>% 
  filter(d1>p | d2>p | d3>p | d4>p | d5>p | d6>p)
```

# overlapping regional densities
``` {r}
obayes$region_post %>% 
    left_join(obayes$locus_rank) %>%
    filter(rank<=10) %>%
    mutate(Region=fct_relevel(subgroup,c("Western Africa", "Southern Africa", "Eastern Africa", "Southern Asia"))) %>%
    ggplot() +
    geom_hline(yintercept=6) +
    geom_hline(yintercept=11) +
    geom_density_ridges(aes(x=prob*100, y=locus, fill=Region), 
                        scale=1, rel_min_height = 0.01, alpha=0.5, col=NA) + 
    scale_y_discrete(limits=rev(obayes$locus_rank$locus[1:10])) + 
  scale_x_continuous(limits=c(0,50)) +
  labs(x="Prevalence per region", y="", fill="Region") + 
  annotate(y=region_5pc_o$locus, label="*", x=49, geom="text") + 
  annotate(y=logistic_sig_o$locus, label="^", x=50, geom="text") +
  scale_fill_manual(values=region_cols) +
  theme_bw()
```

# overlapping regional densities - log2 scale
``` {r}
obayes$region_post %>% 
    left_join(obayes$locus_rank) %>%
    filter(rank<=10) %>%
    mutate(Region=fct_relevel(subgroup,c("Western Africa", "Southern Africa", "Eastern Africa", "Southern Asia"))) %>%
    ggplot() +
    geom_hline(yintercept=11) +
    geom_hline(yintercept=21) +
    geom_density_ridges(aes(x=log2(prob), y=locus, fill=Region), 
                        scale=1, rel_min_height = 0.01, alpha=0.5, col=NA) + 
    scale_y_discrete(limits=rev(obayes$locus_rank$locus[1:10])) + 
  scale_x_continuous(limits=c(-13,0)) +
  labs(x="log2(prevalence) per region", y="", fill="Region") + 
  annotate(y=region_5pc_o$locus, label="*", x=-1, geom="text") + 
  annotate(y=logistic_sig_o$locus, label="^", x=-0.5, geom="text") +
  scale_fill_manual(values=region_cols) +
  theme_bw()
```

``` {r}
ggsave("figures/FigS8_RegionalOBayesDist.pdf", width=6, height=5)
ggsave("figures/FigS8_RegionalOBayesDist.png", width=6, height=5)
```





# Fig S6 = crude annual K rate per region
``` {r}

K_crude_perRegion_perYear <- data_NNS_sites10 %>%
  raw_adj_prop(grouping_vars = c("K_locus", "Region", "Year"), summarise_by = "Region", adj_vars = c("Cluster", "Region", "Year")) 

K_crude_perRegion_perYear <- K_crude_perRegion_perYear %>% group_by(Region, Year) %>% 
  summarise(n=sum(adj_count)) %>% left_join(K_crude_perRegion_perYear) %>%
  mutate(adj_prop = adj_count/n) %>% select(-raw_sum, -adj_sum, -raw_prop, -raw_count)

K_crude_perRegion_perYear %>% 
    left_join(kbayes$locus_rank %>% rename(K_locus=locus)) %>% 
    filter(rank <=30 | K_locus %in% c("KL116", "KL53", "KL81")) %>%
    ggplot(aes(x=Year, fill=Region, y=adj_prop)) + 
    geom_col() +
    theme_bw() + 
    theme(axis.text.x = element_text(angle=45, hjust=1, size=8), 
          axis.text.y=element_text(size=10)) + 
  facet_wrap(~rank+K_locus, scales="free_y") +
    theme(legend.position="bottom") +
  scale_fill_manual(values=region_cols)
```

``` {r}
ggsave("figures/FigS6_crudeRegionAnnualRateK.pdf", width=7, height=9)
ggsave("figures/FigS6_crudeRegionAnnualRateK.png", width=7, height=9)
```


# Fig S9 - simple est per year per O/region
``` {r}
  
O_crude_perRegion_perYear <- data_NNS_sites10 %>%
  raw_adj_prop(grouping_vars = c("O_genotype", "Region", "Year"), summarise_by = "Region", adj_vars = c("Cluster", "Region", "Year")) 

O_crude_perRegion_perYear <- O_crude_perRegion_perYear %>% group_by(Region, Year) %>% 
  summarise(n=sum(adj_count)) %>% left_join(O_crude_perRegion_perYear) %>%
  mutate(adj_prop = adj_count/n) %>% select(-raw_sum, -adj_sum, -raw_prop, -raw_count)

O_crude_perRegion_perYear %>% 
    left_join(obayes$locus_rank %>% rename(O_genotype=locus)) %>% 
    #filter(rank <=12) %>%
    ggplot(aes(x=Year, fill=Region, y=adj_prop)) + 
    geom_col() +
    theme_bw() + 
    theme(axis.text.x = element_text(angle=45, hjust=1, size=10), 
          axis.text.y=element_text(size=10)) + 
  facet_wrap(~rank+O_genotype, scales="free_y", ncol=3) +
    theme(legend.position="bottom") + 
  scale_fill_manual(values=region_cols) + labs(fill="")
```

``` {r}
ggsave("figures/FigS9_crudeRegionAnnualRateO.pdf", width=6, height=8)
ggsave("figures/FigS9_crudeRegionAnnualRateO.png", width=6, height=8)
```


# Figure S10 - ST vs KL coloured by region, for top 4 O types
``` {r}
o_region_ST <- data_NNS_sites10 %>%
  filter(O_genotype %in% c("O2afg", "O4", "O2a", "OL13")) %>%
  mutate(Region=fct_relevel(Region, c("Western Africa", "Southern Africa", "Eastern Africa", "Southern Asia"))) %>%
  ggplot(aes(col=Region, x=K_locus, y=ST)) + 
  geom_jitter(alpha=0.5) +
  theme_bw() + 
  theme(axis.text.x = element_text(angle=45, hjust=1, size=10), 
        axis.text.y=element_text(size=9), legend.position="bottom") +
  scale_colour_manual(values=region_cols) + 
  facet_wrap(~O_genotype, scales="free") + labs(col="", y="", x="")
```

``` {r}
o_region_ST

ggsave("figures/FigS10_O_STvsKbyRegion.pdf", width=7, height=9)
ggsave("figures/FigS10_O_STvsKbyRegion.png", width=7, height=9)
```


# effect of clustering - modelled estimates

``` {r}

kbayes_global <- full_join(kbayes$global_est, kbayes_raw$global_est, by="locus", suffix=c(".adj", ".raw")) 

bayes_global_K_raw_vs_adj <- kbayes_global %>%
  ggplot(aes(x=mean.raw*100, y=mean.adj*100)) + 
  geom_point() + theme_bw() + 
  labs(x="Bayesian estimate (%), raw", y="Bayesian estimate (%), cluster-adjusted") +
  geom_abline(slope=1, intercept=0) + 
  geom_text(data=kbayes_global[kbayes_global$locus %in% kbayes$locus_rank$locus[1:5],], aes(x=mean.raw*100, y=mean.adj*100, label=locus), hjust=1, nudge_x=-0.2, size=2.5)
```

``` {r}

obayes_global <- full_join(obayes$global_est, obayes_raw$global_est, by="locus", suffix=c(".adj", ".raw")) 

bayes_global_O_raw_vs_adj <- obayes_global %>%
  ggplot(aes(x=mean.raw*100, y=mean.adj*100)) + 
  geom_point() + theme_bw() + 
  labs(x="Bayesian estimate (%), raw", y="Bayesian estimate (%), cluster-adjusted") +
  geom_abline(slope=1, intercept=0) + 
  geom_text(data=obayes_global[obayes_global$locus %in% obayes$locus_rank$locus[1:9],], aes(x=mean.raw*100, y=mean.adj*100, label=locus), hjust=1, nudge_x=-0.2, size=2.5)
```

## Figure S14 - cluster vs raw, global K
``` {r}
( (bayes_global_K_raw_vs_adj + ggtitle("a) K locus (mean estimate)") ) + (bayes_global_O_raw_vs_adj  + ggtitle("b) O type (mean estimate)")) + plot_layout(axes="collect") ) / (k_dist_raw_adj + ggtitle ("c) K locus (posterior distribution)") + o_dist_raw_adj + ggtitle ("d) O type (posterior distribution)") + plot_layout(guides="collect")) + plot_layout(heights=c(1,2)) & theme(legend.position='bottom')


ggsave("figures/FigS14_clusterVsRaw.pdf", width=8, height=11)
ggsave("figures/FigS14_clusterVsRaw.png", width=8, height=11)
```

# Effect of cluster adjustment on crude proportion
``` {r}
K_crude_global <- data_NNS_sites10 %>%
 group_by(K_locus) %>% summarise(raw_count=n(), raw_prop=raw_count/nrow(data_NNS_sites10))

K_crude_global <- data_NNS_sites10 %>% select(K_locus, Cluster) %>% distinct() %>%
 group_by(K_locus) %>% 
  summarise(adj_count=n(), adj_prop=adj_count/length(unique(data_NNS_sites10$Cluster))) %>%
  right_join(K_crude_global)

O_crude_global <- data_NNS_sites10 %>%
 group_by(O_genotype) %>% summarise(raw_count=n(), raw_prop=raw_count/nrow(data_NNS_sites10))

O_crude_global <- data_NNS_sites10 %>% select(O_genotype, Cluster) %>% distinct() %>%
 group_by(O_genotype) %>% 
  summarise(adj_count=n(), adj_prop=adj_count/length(unique(data_NNS_sites10$Cluster))) %>%
  right_join(O_crude_global)

```

``` {r}
K_crude_global %>% ggplot(aes(y=adj_prop*100, x=raw_prop*100)) + 
  geom_point() + 
  theme_bw() + 
  labs(x="Crude estimate (%), raw", y="Crude estimate (%), cluster-adjusted") +
  geom_abline(slope=1, intercept=0) + 
  geom_text(data=K_crude_global[K_crude_global$K_locus %in% kbayes$locus_rank$locus[1:5],], aes(x=raw_prop*100, y=adj_prop*100, label=K_locus), hjust=1, nudge_x=-0.2, size=2.5)
```


# Effect of cluster adjustment on crude proportion per site
``` {r}
K_crude_perSite <- data_NNS_sites10 %>%
  raw_adj_prop(grouping_vars = c("K_locus", "Site"), summarise_by = "Site", adj_vars = c("Cluster", "Site")) %>%
  mutate(raw_prop = raw_count/raw_sum) %>%
  mutate(adj_prop = adj_count/adj_sum)

O_crude_perSite <- data_NNS_sites10 %>%
  raw_adj_prop(grouping_vars = c("O_genotype", "Site"), summarise_by = "Site", adj_vars = c("Cluster", "Site")) %>%
  mutate(raw_prop = raw_count/raw_sum) %>%
  mutate(adj_prop = adj_count/adj_sum)
```

``` {r}
# KL25
K_crude_raw_adj_scatter_KL25 <- K_crude_perSite %>% 
  filter(K_locus=="KL25") %>%
  ggplot(aes(x=raw_prop, y=adj_prop)) +
  geom_point() + 
  geom_abline(slope=1, intercept=0) +
  theme_bw() +
  labs(x="Crude proportion, raw", y="Crude proportion, adjusted")

# KL2
K_crude_raw_adj_scatter_KL2 <- K_crude_perSite %>% 
  filter(K_locus=="KL2") %>%
  ggplot(aes(x=raw_prop, y=adj_prop)) +
  geom_point() + 
  geom_abline(slope=1, intercept=0) +
  theme_bw() +
  labs(x="Crude proportion, raw", y="Crude proportion, adjusted")

# KL102
K_crude_raw_adj_scatter_KL102 <- K_crude_perSite %>% 
  filter(K_locus=="KL102") %>%
  ggplot(aes(x=raw_prop, y=adj_prop)) +
  geom_point() + 
  geom_abline(slope=1, intercept=0) +
  theme_bw() +
  labs(x="Crude proportion, raw", y="Crude proportion, adjusted")

# KL62
K_crude_raw_adj_scatter_KL62 <- K_crude_perSite %>% 
  filter(K_locus=="KL62") %>%
  ggplot(aes(x=raw_prop, y=adj_prop)) +
  geom_point() + 
  geom_abline(slope=1, intercept=0) +
  theme_bw() +
  labs(x="Crude proportion, raw", y="Crude proportion, adjusted")

# O1v1
O_crude_raw_adj_scatter_O1v1 <- O_crude_perSite %>% 
  filter(O_genotype=="O1.v1") %>%
  ggplot(aes(x=raw_prop, y=adj_prop)) +
  geom_point() + 
  geom_abline(slope=1, intercept=0) +
  theme_bw() +
  labs(x="Crude proportion, raw", y="Crude proportion, adjusted")

# O1v2
O_crude_raw_adj_scatter_O1v2 <- O_crude_perSite %>% 
  filter(O_genotype=="O1.v2") %>%
  ggplot(aes(x=raw_prop, y=adj_prop)) +
  geom_point() + 
  geom_abline(slope=1, intercept=0) +
  theme_bw() +
  labs(x="Crude proportion, raw", y="Crude proportion, adjusted")

# O2afg
O_crude_raw_adj_scatter_O2afg <- O_crude_perSite %>% 
  filter(O_genotype=="O2afg") %>%
  ggplot(aes(x=raw_prop, y=adj_prop)) +
  geom_point() + 
  geom_abline(slope=1, intercept=0) +
  theme_bw() +
  labs(x="Crude proportion, raw", y="Crude proportion, adjusted")

# O4
O_crude_raw_adj_scatter_O4 <- O_crude_perSite %>% 
  filter(O_genotype=="O4") %>%
  ggplot(aes(x=raw_prop, y=adj_prop)) +
  geom_point() + 
  geom_abline(slope=1, intercept=0) +
  theme_bw() +
  labs(x="Crude proportion, raw", y="Crude proportion, adjusted")

```

# Fig S13 - Effect of cluster adjustment on crude proportion
``` {r}
(K_crude_raw_adj_scatter_KL102 + ggtitle("a) KL102, per-site") + K_crude_raw_adj_scatter_KL2 + ggtitle("b) KL2, per-site")) / (K_crude_raw_adj_scatter_KL25 + ggtitle("c) KL25, per-site") + K_crude_raw_adj_scatter_KL62 + ggtitle("d) KL62, per-site")) / (O_crude_raw_adj_scatter_O1v1 + ggtitle("e) O1v1, per-site") + O_crude_raw_adj_scatter_O1v2 + ggtitle("f) O1v2, per-site")) / (O_crude_raw_adj_scatter_O2afg + ggtitle("g) O2afg, per-site") + O_crude_raw_adj_scatter_O4 + ggtitle("h) O4, per-site"))

ggsave("figures/FigS13_EffectClusteringCrude.pdf", width=8, height=10)
ggsave("figures/FigS13_EffectClusteringCrude.png", width=8, height=10)
```



## numbers for text - K prevalence estimates
``` {r}

kbayes$global_est

kbayes$global_est %>% filter(rank<=5)

kbayes$global_est %>% filter(median>0.02)

kbayes$global_est %>% filter(median>0.01)

kbayes$global_est %>% filter(locus=="KL149")
kbayes$region_est %>% filter(locus=="KL149")

kbayes$global_est %>% filter(locus=="KL15")
kbayes$region_est %>% filter(locus=="KL15")

kbayes$global_est %>% filter(locus=="KL51")
kbayes$region_est %>% filter(locus=="KL51")


kbayes$global_est %>% filter(locus=="KL81")
kbayes$region_est %>% filter(locus=="KL81")

kbayes$global_est %>% filter(locus=="KL28")
kbayes$region_est %>% filter(locus=="KL28")

kbayes$global_est %>% filter(locus=="KL116")
kbayes$region_est %>% filter(locus=="KL116")

kbayes$global_est %>% filter(locus=="KL53")
kbayes$region_est %>% filter(locus=="KL53")

```

# numbers for text - O antigen
``` {r}
obayes$global_est

obayes$global_est %>% filter(rank<=5) %>% pull(median) %>% sum()
obayes$global_est %>% filter(rank<=5) %>% pull(lower) %>% sum()
obayes$global_est %>% filter(rank<=5) %>% pull(upper) %>% sum()

obayes$global_est
```

# numbers for text - O differences by region
``` {r}
# where is O4 found
data_NNS_sites10 %>% filter(O_genotype=="O4") %>% group_by(Region, Study, Site, ST, K_locus) %>% count() %>% arrange(-n)
data_NNS_sites10 %>% filter(O_genotype=="O4" & Region=="Southern Asia") %>% group_by(ST, K_locus) %>% count() %>% arrange(-n)
data_NNS_sites10 %>% filter(O_genotype=="O4" & Region=="Southern Asia") %>% group_by(ST, K_locus, Site) %>% count() %>% arrange(-n)

data_NNS_sites10 %>% filter(O_genotype=="O2a.v1") %>% group_by(Region, Study, Site, ST, K_locus) %>% count() %>% arrange(-n)
data_NNS_sites10 %>% filter(O_genotype=="O2a.v1" & Region=="Southern Asia") %>% group_by(ST, K_locus) %>% count() %>% arrange(-n)
data_NNS_sites10 %>% filter(O_genotype=="O2a.v1" & Region=="Southern Asia") %>% group_by(ST, K_locus, Site) %>% count() %>% arrange(-n)

data_NNS_sites10 %>% filter(O_genotype=="O5") %>% group_by(Region, Study, Site, ST, K_locus) %>% count() %>% arrange(-n)
data_NNS_sites10 %>% filter(O_genotype=="O5" & Region=="Southern Africa") %>% group_by(ST, K_locus) %>% count() %>% arrange(-n)
data_NNS_sites10 %>% filter(O_genotype=="O5" & Region=="Southern Africa") %>% group_by(ST, K_locus, Site) %>% count() %>% arrange(-n)

```


# Global and regional coverage - top20 global - Fig3bi
``` {r}

kbayes_raw_coverage <- getCumulativeCoverageGlobalRegional(kbayes_raw, kbayes$locus_rank) %>%
  mutate(subgroup=fct_relevel(subgroup,c("Global", "Southern Asia", "Eastern Africa", "Southern Africa", "Western Africa")))

coverage_globalTop20_globalRegional <- plotCoverage(kbayes_raw_coverage, kbayes$locus_rank, maxRank=20, cols=region_cols)

coverage_globalTop20_globalRegional

```


## fatal - read posterior estimates for adjusted counts (main) and raw counts (for comparison)
``` {r}

# read raw Bayesian estimates for K - using fatal samples from sites with at least 10 fatal
kbayes_fatal_raw_min10perSite <- parseModelledEstimates(global_post="outputs_paper/K_Fatal_min10_raw_28_posterior_global.csv.gz", region_post="outputs_paper/K_Fatal_min10_raw_28_posterior_subgroup.csv.gz")

```

``` {r}

kbayes_fatal_raw_min10perSite_coverage <- getCumulativeCoverage(kbayes$locus_rank, kbayes_fatal_raw_min10perSite$global_post) %>% mutate(type="min10")

```

## ESBL - read posterior estimates for adjusted counts (main) and raw counts (for comparison)
``` {r}

# read adjusted Bayesian estimates for K - using all ESBL samples
kbayes_esbl_raw <- parseModelledEstimates(global_post="outputs_paper/K_ESBL_ALL_raw_28_posterior_global.csv.gz", region_post="outputs_paper/K_ESBL_ALL_raw_28_posterior_subgroup.csv.gz")

# read raw Bayesian estimates for K - using ESBL samples from sites with at least 10 ESBL
kbayes_esbl_raw_min10perSite <- parseModelledEstimates(global_post="outputs_paper/K_ESBL_min10_raw_28_posterior_global.csv.gz", region_post="outputs_paper/K_ESBL_min10_raw_28_posterior_subgroup.csv.gz")

```

``` {r}

kbayes_esbl_raw_coverage <- getCumulativeCoverage(kbayes$locus_rank, kbayes_esbl_raw$global_post) %>% mutate(type="all")

kbayes_esbl_raw_min10perSite_coverage <- getCumulativeCoverage(kbayes$locus_rank, kbayes_esbl_raw_min10perSite$global_post) %>% mutate(type="min10")

# compare results using all data vs only sites with at least 10 fatal cases - very little difference
kbayes_esbl_raw_coverage %>% 
  bind_rows(kbayes_esbl_raw_min10perSite_coverage) %>%
  filter(rank <=20) %>%
  ggplot(aes(x=rank, y=mean*100, group=type)) +
    geom_hline(yintercept=70, linetype=2) + geom_vline(xintercept=c(5,10,15,20), col="grey") +
    geom_line(aes(col=type), lwd=1) + 
    geom_ribbon(aes(ymin=lower*100, ymax=upper*100, fill=type), alpha=0.1, linetype=0) +
    theme_bw() +
    ylim(0,100) + 
    labs(x=NULL, y="Cumulative coverage (%)", fill="", colour="", linetype="") +
    theme(axis.text.x = element_text(angle=90), panel.grid.minor.x = element_blank()) +
    scale_x_continuous(breaks=seq(1,20), labels=kbayes$locus_rank$locus[1:20]) 


(kbayes_esbl_raw_coverage$mean - kbayes_esbl_raw_min10perSite_coverage$mean)*100
```


## CP - read posterior estimates for adjusted counts (main) and raw counts (for comparison)
``` {r}

# read adjusted Bayesian estimates for K - using all CP samples
kbayes_cp_raw <- parseModelledEstimates(global_post="outputs_paper/K_Carba_ALL_raw_28_posterior_global.csv.gz", region_post="outputs_paper/K_Carba_ALL_raw_28_posterior_subgroup.csv.gz")

# read raw Bayesian estimates for K - using CP samples from sites with at least 10 CP
kbayes_cp_raw_min10perSite <- parseModelledEstimates(global_post="outputs_paper/K_Carba_min10_raw_28_posterior_global.csv.gz", region_post="outputs_paper/K_Carba_min10_raw_28_posterior_subgroup.csv.gz")

```

``` {r}

kbayes_cp_raw_coverage <- getCumulativeCoverage(kbayes$locus_rank, kbayes_cp_raw$global_post) %>% mutate(type="all")

kbayes_cp_raw_min10perSite_coverage <- getCumulativeCoverage(kbayes$locus_rank, kbayes_cp_raw_min10perSite$global_post) %>% mutate(type="min10")

# compare results using all data vs only sites with at least 10 fatal cases - very little difference
kbayes_cp_raw_coverage %>% 
  bind_rows(kbayes_cp_raw_min10perSite_coverage) %>%
  filter(rank <=20) %>%
  ggplot(aes(x=rank, y=mean*100, group=type)) +
    geom_hline(yintercept=70, linetype=2) + geom_vline(xintercept=c(5,10,15,20), col="grey") +
    geom_line(aes(col=type), lwd=1) + 
    geom_ribbon(aes(ymin=lower*100, ymax=upper*100, fill=type), alpha=0.1, linetype=0) +
    theme_bw() +
    ylim(0,100) + 
    labs(x=NULL, y="Cumulative coverage (%)", fill="", colour="", linetype="") +
    theme(axis.text.x = element_text(angle=90), panel.grid.minor.x = element_blank()) +
    scale_x_continuous(breaks=seq(1,20), labels=kbayes$locus_rank$locus[1:20]) 


(kbayes_cp_raw_coverage$mean - kbayes_cp_raw_min10perSite_coverage$mean)*100
```

# combine coverage estimates for subgroups (fatal, ESBL, CP) - Fig3ai
``` {r}

kbayes_raw_coverage_subgroups <- kbayes_esbl_raw_min10perSite_coverage %>% mutate(subgroup="ESBL") %>%
  bind_rows(kbayes_cp_raw_min10perSite_coverage %>% mutate(subgroup="CP")) %>%
  bind_rows(kbayes_fatal_raw_min10perSite_coverage %>% mutate(subgroup="Fatal")) %>%
  bind_rows(kbayes_raw_coverage %>% filter(subgroup=="Global") %>% mutate(subgroup="All") ) %>%
  mutate(subgroup=fct_relevel(subgroup,c("All", "Fatal", "ESBL", "CP")))


coverage_globalTop20_subgroups <- plotCoverage(kbayes_raw_coverage_subgroups, kbayes$locus_rank, maxRank=20, cols=group_cols)

coverage_globalTop20_subgroups

```

# try to improve by taking top 8 per region - Fig3aii and Fig3bii
``` {r}

## extract cluster-adjusted coverage per region
K_rank_SA <- kbayes$region_est %>% ungroup %>% filter(subgroup=="Southern Africa") %>% arrange(-mean) %>% mutate(rank=row_number())
K_rank_WA <- kbayes$region_est %>% ungroup %>% filter(subgroup=="Western Africa") %>% arrange(-mean) %>% mutate(rank=row_number())
K_rank_EA <- kbayes$region_est %>% ungroup %>% filter(subgroup=="Eastern Africa") %>% arrange(-mean) %>% mutate(rank=row_number())
K_rank_SAs <- kbayes$region_est %>% ungroup %>% filter(subgroup=="Southern Asia") %>% arrange(-mean) %>% mutate(rank=row_number())


# get top-8 within each region - gives 21 loci
n<-8

topN <- bind_rows(K_rank_SA, K_rank_EA) %>% bind_rows(K_rank_WA) %>% bind_rows(K_rank_SAs) %>% filter(rank<=n) %>% pull(locus) %>% unique()

length(unique(topN))

kbayes$locus_rank[kbayes$locus_rank$locus %in% topN,]

# remove KL8, as this only benefits Southern Africa which already exceeds 80% without KL9, and brings us back to 20 loci
k_rank_region8 <- kbayes$locus_rank[kbayes$locus_rank$locus %in% topN,] %>% 
  filter(locus!="KL9") %>%
  mutate(rank=1:(length(unique(topN))-1))

# calculate global & regional coverage for these K - Fig 3bii
kbayes_raw_coverage_top8perRegion <- getCumulativeCoverageGlobalRegional(kbayes_raw, k_rank_region8) %>%
  mutate(subgroup=fct_relevel(subgroup,c("Global", "Southern Asia", "Eastern Africa", "Southern Africa", "Western Africa")))

coverage_global_top8perRegion <- plotCoverage(kbayes_raw_coverage_top8perRegion, k_rank_region8, maxRank=nrow(k_rank_region8), cols=region_cols)

coverage_global_top8perRegion

# calculate subgroup coverage for these K - Fig 3aii
kbayes_fatal_raw_min10perSite_coverage_top8perRegion <- getCumulativeCoverage(k_rank_region8, kbayes_fatal_raw_min10perSite$global_post)
kbayes_esbl_raw_min10perSite_coverage_top8perRegion <- getCumulativeCoverage(k_rank_region8, kbayes_esbl_raw_min10perSite$global_post)
kbayes_cp_raw_min10perSite_coverage_top8perRegion <- getCumulativeCoverage(k_rank_region8, kbayes_cp_raw_min10perSite$global_post)

kbayes_raw_coverage_subgroups_top8perRegion <- kbayes_esbl_raw_min10perSite_coverage_top8perRegion %>% mutate(subgroup="ESBL") %>%
  bind_rows(kbayes_cp_raw_min10perSite_coverage_top8perRegion %>% mutate(subgroup="CP")) %>%
  bind_rows(kbayes_fatal_raw_min10perSite_coverage_top8perRegion %>% mutate(subgroup="Fatal")) %>%
  bind_rows(kbayes_raw_coverage_top8perRegion %>% filter(subgroup=="Global") %>% mutate(subgroup="All") ) %>%
  mutate(subgroup=fct_relevel(subgroup,c("All", "Fatal", "ESBL", "CP")))

coverage_subgroups_top8perRegion <- plotCoverage(kbayes_raw_coverage_subgroups_top8perRegion, k_rank_region8, maxRank=nrow(k_rank_region8), cols=group_cols)

coverage_subgroups_top8perRegion


```

``` {r}
(coverage_globalTop20_subgroups + ggtitle("a) Global coverage, by case type", subtitle="KL set 1: global top-20") + coverage_subgroups_top8perRegion + ggtitle("", subtitle="KL set 2: top-8 per region") + plot_layout(guides="collect", axes="collect")) / (coverage_globalTop20_globalRegional + ggtitle("b) Per-region coverage", subtitle="KL set 1: global top-20") + coverage_global_top8perRegion + ggtitle("", subtitle="KL set 2: top-8 per region") + plot_layout(guides="collect", axes="collect"))

ggsave("figures/Fig3_Kcoverage_raw.pdf", width=8, height=8)
ggsave("figures/Fig3_Kcoverage_raw.png", width=8, height=8)
```


# Table 2 - coverage stats for all/ESBL/CP/fatal, for global and regional

``` {r}
kbayes_fatal_raw_min10perSite_coverageRegional <- getCumulativeCoverageGlobalRegional(ranks=kbayes$locus_rank, bayes=kbayes_fatal_raw_min10perSite, maxRank=20)

kbayes_esbl_raw_min10perSite_coverageRegional <- getCumulativeCoverageGlobalRegional(ranks=kbayes$locus_rank, bayes=kbayes_esbl_raw_min10perSite, maxRank=20)

kbayes_cp_raw_min10perSite_coverageRegional <- getCumulativeCoverageGlobalRegional(ranks=kbayes$locus_rank, bayes=kbayes_cp_raw_min10perSite, maxRank=20)

table2 <- kbayes_raw_coverage %>% mutate(cases="All") %>%
  bind_rows(kbayes_fatal_raw_min10perSite_coverageRegional %>% mutate(cases="  Fatal infections")) %>%
  bind_rows(kbayes_esbl_raw_min10perSite_coverageRegional %>% mutate(cases="  ESBL infections")) %>%
  bind_rows(kbayes_cp_raw_min10perSite_coverageRegional %>% mutate(cases="  CP infections")) %>%
  filter(rank %in% c(5,10,15,20)) %>% 
  mutate(upper=if_else(upper>1, 1, upper)) %>%
  mutate(summary=paste0(round(mean,3)*100," (",round(lower,3)*100,"-",round(upper,3)*100,")")) %>% 
  select(rank, subgroup, cases, summary) %>% 
  pivot_wider(names_from=rank, values_from=summary, id_cols=c(subgroup, cases)) %>%
  rename(Region=subgroup)

```

# add totals per subgroup
``` {r}
esbl_counts <- data_NNS_sites10 %>% filter(resistance_score>=1) %>% group_by(Region) %>% count()
esbl_counts <- esbl_counts %>% bind_rows(list(Region="Global", n=sum(esbl_counts$n)))

cp_counts <- data_NNS_sites10 %>% filter(resistance_score>=2) %>% group_by(Region) %>% count()
cp_counts <- cp_counts %>% bind_rows(list(Region="Global", n=sum(cp_counts$n)))

total_counts <- data_NNS_sites10 %>% group_by(Region) %>% count()
total_counts <- total_counts %>% bind_rows(list(Region="Global", n=sum(cp_counts$n)))

```

``` {r}
## merge mortality info
mortality <- read_csv("mortality_all_20250313.csv")

data_NNS_sites10 <- data_NNS_sites10 %>% left_join(mortality, multiple="last")

data_NNS_sites10 %>% group_by(Study, Mortality) %>% count()

fatal_counts <- data_NNS_sites10 %>% filter(Mortality==1) %>% group_by(Region) %>% count()
fatal_counts <- fatal_counts %>% bind_rows(list(Region="Global", n=sum(fatal_counts$n)))
```

``` {r}
table2 <- esbl_counts %>% mutate(cases="  ESBL infections") %>%
  bind_rows(cp_counts%>% mutate(cases="  CP infections")) %>%
  bind_rows(fatal_counts %>% mutate(cases="  Fatal infections")) %>%
  bind_rows(total_counts %>% mutate(cases="All")) %>%
  full_join(table2, by=c("Region", "cases")) %>%
  mutate(cases=fct_relevel(cases,c("All", "  Fatal infections", "  ESBL infections", "  CP infections")))

# sort function isn't working when ordering region factor using fct_relevel
table2$Region <- factor(table2$Region, levels = c("Global", "Eastern Africa", "Southern Africa", "Western Africa", "Southern Asia"))

table2 <- table2 %>%
  arrange(Region, cases) %>%
  relocate(n, .after=cases) %>% 
  mutate(cases=if_else(cases=="All", Region, cases)) %>%
  rename_with(~ paste0(.x, " KL"), c("5", "10", "15", "20")) %>%
  rename(N=n) %>%
  rename(Data=cases) %>%
  ungroup %>% select(-Region)
  
write_tsv(table2, file="tables/Table2_coverage.tsv")
```

# Table S4 - K set2 coverage stats for all/ESBL/CP/fatal, for global and regional

``` {r}
kbayes_fatal_raw_min10perSite_coverageRegional_top8perRegion <- getCumulativeCoverageGlobalRegional(ranks=k_rank_region8, bayes=kbayes_fatal_raw_min10perSite, maxRank=20)

kbayes_esbl_raw_min10perSite_coverageRegional_top8perRegion <- getCumulativeCoverageGlobalRegional(ranks=k_rank_region8, bayes=kbayes_esbl_raw_min10perSite, maxRank=20)

kbayes_cp_raw_min10perSite_coverageRegional_top8perRegion <- getCumulativeCoverageGlobalRegional(ranks=k_rank_region8, bayes=kbayes_cp_raw_min10perSite, maxRank=20)

tableS4 <- kbayes_raw_coverage_top8perRegion %>% mutate(cases="All") %>%
  bind_rows(kbayes_fatal_raw_min10perSite_coverageRegional_top8perRegion %>% mutate(cases="  Fatal infections")) %>%
  bind_rows(kbayes_esbl_raw_min10perSite_coverageRegional_top8perRegion %>% mutate(cases="  ESBL infections")) %>%
  bind_rows(kbayes_cp_raw_min10perSite_coverageRegional_top8perRegion %>% mutate(cases="  CP infections")) %>%
  mutate(upper=if_else(upper>1, 1, upper)) %>%
  filter(rank %in% c(5,10,15,20)) %>% 
  mutate(summary=paste0(round(mean,3)*100," (",round(lower,3)*100,"-",round(upper,3)*100,")")) %>% 
  select(rank, subgroup, cases, summary) %>% 
  pivot_wider(names_from=rank, values_from=summary, id_cols=c(subgroup, cases)) %>%
  rename(Region=subgroup)

```

``` {r}
tableS4 <- esbl_counts %>% mutate(cases="  ESBL infections") %>%
  bind_rows(cp_counts%>% mutate(cases="  CP infections")) %>%
  bind_rows(fatal_counts %>% mutate(cases="  Fatal infections")) %>%
  bind_rows(total_counts %>% mutate(cases="All")) %>%
  full_join(tableS4, by=c("Region", "cases")) %>%
  mutate(cases=fct_relevel(cases,c("All", "  Fatal infections", "  ESBL infections", "  CP infections")))

# sort function isn't working when ordering region factor using fct_relevel
tableS4$Region <- factor(tableS4$Region, levels = c("Global", "Eastern Africa", "Southern Africa", "Western Africa", "Southern Asia"))

tableS4 <- tableS4 %>%
  arrange(Region, cases) %>%
  relocate(n, .after=cases) %>% 
  mutate(cases=if_else(cases=="All", Region, cases)) %>%
  rename_with(~ paste0(.x, " KL"), c("5", "10", "15", "20")) %>%
  rename(N=n) %>%
  rename(Data=cases) %>%
  ungroup %>% select(-Region)
  
write_tsv(tableS4, file="tables/TableS4_coverageSet2.tsv")
```

# Fig S7 - coverage for region-focused K sets
``` {r}
# ranked by Southern Africa
kbayes_raw_coverage_top20SA <- getCumulativeCoverageGlobalRegional(kbayes_raw, K_rank_SA %>% select(locus, rank), maxRank=20) %>%
  mutate(subgroup=fct_relevel(subgroup,c("Global", "Southern Asia", "Eastern Africa", "Southern Africa", "Western Africa")))

kbayes_raw_coverage_globalRegional_top20SA <- plotCoverage(kbayes_raw_coverage_top20SA, K_rank_SA %>% select(locus, rank), maxRank=20, cols=region_cols)

# ranked by Eastern Africa
kbayes_raw_coverage_top20EA <- getCumulativeCoverageGlobalRegional(kbayes_raw, K_rank_EA %>% select(locus, rank), maxRank=20) %>%
  mutate(subgroup=fct_relevel(subgroup,c("Global", "Southern Asia", "Eastern Africa", "Southern Africa", "Western Africa")))

kbayes_raw_coverage_globalRegional_top20EA <- plotCoverage(kbayes_raw_coverage_top20EA, K_rank_EA %>% select(locus, rank), maxRank=20, cols=region_cols)

# ranked by Western Africa
kbayes_raw_coverage_top20WA <- getCumulativeCoverageGlobalRegional(kbayes_raw, K_rank_WA %>% select(locus, rank), maxRank=20) %>%
  mutate(subgroup=fct_relevel(subgroup,c("Global", "Southern Asia", "Eastern Africa", "Southern Africa", "Western Africa")))

kbayes_raw_coverage_globalRegional_top20WA <- plotCoverage(kbayes_raw_coverage_top20WA, K_rank_WA %>% select(locus, rank), maxRank=20, cols=region_cols)

# ranked by Southern Asia
kbayes_raw_coverage_top20SAs <- getCumulativeCoverageGlobalRegional(kbayes_raw, K_rank_SAs %>% select(locus, rank), maxRank=20) %>%
  mutate(subgroup=fct_relevel(subgroup,c("Global", "Southern Asia", "Eastern Africa", "Southern Africa", "Western Africa")))

kbayes_raw_coverage_globalRegional_top20SAs <- plotCoverage(kbayes_raw_coverage_top20SAs, K_rank_SAs %>% select(locus, rank), maxRank=20, cols=region_cols)

```

``` {r}

(kbayes_raw_coverage_globalRegional_top20SA + ggtitle("Top-20 K loci in S. Africa") + kbayes_raw_coverage_globalRegional_top20EA + ggtitle("Top-20 K loci in E. Africa")) / (kbayes_raw_coverage_globalRegional_top20WA + ggtitle("Top-20 K loci in W. Africa") + kbayes_raw_coverage_globalRegional_top20SAs + ggtitle("Top-20 K loci in S. Asia")) + plot_layout(guides="collect")

ggsave("figures/FigS7_KcoverageRaw_top20PerRegion.pdf", width=8, height=8)
ggsave("figures/FigS7_KcoverageRaw_top20PerRegion.png", width=8, height=8)
```

# numbers for text - K coverage
``` {r}
# coverage of top-20
kbayes_raw_coverage %>% filter(rank %in% c(5,10,15,20) & subgroup=="Global") %>% select(mean, lower, upper)

kbayes_raw_coverage %>% filter(rank==10 & subgroup=="Global") %>% select(mean, lower, upper) - (kbayes_raw_coverage %>% filter(rank==5 & subgroup=="Global") %>% select(mean, lower, upper))

kbayes_raw_coverage %>% filter(rank==15 & subgroup=="Global") %>% select(mean, lower, upper) - (kbayes_raw_coverage %>% filter(rank==10 & subgroup=="Global") %>% select(mean, lower, upper))

kbayes_raw_coverage %>% filter(rank==20 & subgroup=="Global") %>% select(mean, lower, upper) - (kbayes_raw_coverage %>% filter(rank==15 & subgroup=="Global") %>% select(mean, lower, upper))

# available data on fatal cases
data_NNS_sites10 %>% filter(!is.na(Mortality)) %>% nrow()
data_NNS_sites10 %>% filter(Mortality==1) %>% nrow()

# coverage of region-focused subsets
kbayes_raw_coverage_globalRegional_top20SA$data %>% filter(rank==20)
kbayes_raw_coverage_globalRegional_top20EA$data %>% filter(rank==20)
kbayes_raw_coverage_globalRegional_top20WA$data %>% filter(rank==20)
kbayes_raw_coverage_globalRegional_top20SAs$data %>% filter(rank==20)

# coverage of KL set 2
kbayes_raw_coverage_top8perRegion%>% filter(rank==20)
kbayes_raw_coverage_subgroups_top8perRegion %>% filter(rank==20)

# what is extra in set2 that is not in top-20?
k_rank_region8 %>% left_join(kbayes$locus, by="locus") %>% filter(rank.y>20)
```



# Global and regional O coverage - top10 global - Fig4d
``` {r}

obayes_raw_coverage <- getCumulativeCoverageGlobalRegional(obayes_raw, obayes$locus_rank) %>%
  mutate(subgroup=fct_relevel(subgroup,c("Global", "Southern Asia", "Eastern Africa", "Southern Africa", "Western Africa")))

ocoverage_globalTop10_globalRegional <- plotCoverage(obayes_raw_coverage, obayes$locus_rank, maxRank=10, xintercept=c(5,10), cols=region_cols, col_title = "d) Region")

ocoverage_globalTop10_globalRegional

```


## O fatal - read posterior estimates for adjusted counts (main) and raw counts (for comparison)
``` {r}

# read raw Bayesian estimates for O - using fatal samples from sites with at least 10 fatal
obayes_fatal_raw_min10perSite <- parseModelledEstimates(global_post="outputs_paper/O_Fatal_min10_raw_28_posterior_global.csv.gz", region_post="outputs_paper/O_Fatal_min10_raw_28_posterior_subgroup.csv.gz", fixOnames = T)

```

``` {r}

obayes_fatal_raw_min10perSite_coverage <- getCumulativeCoverage(obayes$locus_rank, obayes_fatal_raw_min10perSite$global_post) %>% mutate(type="min10")

```

## ESBL - read posterior estimates for adjusted counts (main) and raw counts (for comparison)
``` {r}

# read adjusted Bayesian estimates for O - using all ESBL samples
obayes_esbl_raw <- parseModelledEstimates(global_post="outputs_paper/O_ESBL_ALL_raw_28_posterior_global.csv.gz", region_post="outputs_paper/O_ESBL_ALL_raw_28_posterior_subgroup.csv.gz", fixOnames = T)

# read raw Bayesian estimates for O - using ESBL samples from sites with at least 10 ESBL
obayes_esbl_raw_min10perSite <- parseModelledEstimates(global_post="outputs_paper/O_ESBL_min10_raw_28_posterior_global.csv.gz", region_post="outputs_paper/O_ESBL_min10_raw_28_posterior_subgroup.csv.gz", fixOnames = T)

```

``` {r}

obayes_esbl_raw_coverage <- getCumulativeCoverage(obayes$locus_rank, obayes_esbl_raw$global_post) %>% mutate(type="all")

obayes_esbl_raw_min10perSite_coverage <- getCumulativeCoverage(obayes$locus_rank, obayes_esbl_raw_min10perSite$global_post) %>% mutate(type="min10")

# compare results using all data vs only sites with at least 10 ESBL cases - very little difference
obayes_esbl_raw_coverage %>% 
  bind_rows(obayes_esbl_raw_min10perSite_coverage) %>%
  filter(rank <=20) %>%
  ggplot(aes(x=rank, y=mean*100, group=type)) +
    geom_hline(yintercept=70, linetype=2) + geom_vline(xintercept=c(5,10,15,20), col="grey") +
    geom_line(aes(col=type), lwd=1) + 
    geom_ribbon(aes(ymin=lower*100, ymax=upper*100, fill=type), alpha=0.1, linetype=0) +
    theme_bw() +
    ylim(0,100) + 
    labs(x=NULL, y="Cumulative coverage (%)", fill="", colour="", linetype="") +
    theme(axis.text.x = element_text(angle=90), panel.grid.minor.x = element_blank()) +
    scale_x_continuous(breaks=seq(1,20), labels=obayes$locus_rank$locus[1:20]) 


(obayes_esbl_raw_coverage$mean - obayes_esbl_raw_min10perSite_coverage$mean)*100
```


## CP - read posterior estimates for adjusted counts (main) and raw counts (for comparison)
``` {r}

# read adjusted Bayesian estimates for O - using all CP samples
obayes_cp_raw <- parseModelledEstimates(global_post="outputs_paper/O_Carba_ALL_raw_28_posterior_global.csv.gz", region_post="outputs_paper/O_Carba_ALL_raw_28_posterior_subgroup.csv.gz", fixOnames = T)

# read raw Bayesian estimates for O - using CP samples from sites with at least 10 CP
obayes_cp_raw_min10perSite <- parseModelledEstimates(global_post="outputs_paper/O_Carba_min10_raw_28_posterior_global.csv.gz", region_post="outputs_paper/O_Carba_min10_raw_28_posterior_subgroup.csv.gz", fixOnames = T)

```

``` {r}

obayes_cp_raw_coverage <- getCumulativeCoverage(obayes$locus_rank, obayes_cp_raw$global_post) %>% mutate(type="all")

obayes_cp_raw_min10perSite_coverage <- getCumulativeCoverage(obayes$locus_rank, obayes_cp_raw_min10perSite$global_post) %>% mutate(type="min10")

# compare results using all data vs only sites with at least 10 CP cases - very little difference
obayes_cp_raw_coverage %>% 
  bind_rows(obayes_cp_raw_min10perSite_coverage) %>%
  filter(rank <=20) %>%
  ggplot(aes(x=rank, y=mean*100, group=type)) +
    geom_hline(yintercept=70, linetype=2) + geom_vline(xintercept=c(5,10,15,20), col="grey") +
    geom_line(aes(col=type), lwd=1) + 
    geom_ribbon(aes(ymin=lower*100, ymax=upper*100, fill=type), alpha=0.1, linetype=0) +
    theme_bw() +
    ylim(0,100) + 
    labs(x=NULL, y="Cumulative coverage (%)", fill="", colour="", linetype="") +
    theme(axis.text.x = element_text(angle=90), panel.grid.minor.x = element_blank()) +
    scale_x_continuous(breaks=seq(1,20), labels=obayes$locus_rank$locus[1:20]) 


(obayes_cp_raw_coverage$mean - obayes_cp_raw_min10perSite_coverage$mean)*100
```

# combine coverage estimates for subgroups (fatal, ESBL, CP) - Fig4c
``` {r}

obayes_raw_coverage_subgroups <- obayes_esbl_raw_min10perSite_coverage %>% mutate(subgroup="ESBL") %>%
  bind_rows(obayes_cp_raw_min10perSite_coverage %>% mutate(subgroup="CP")) %>%
  bind_rows(obayes_fatal_raw_min10perSite_coverage %>% mutate(subgroup="Fatal")) %>%
  bind_rows(obayes_raw_coverage %>% filter(subgroup=="Global") %>% mutate(subgroup="All") ) %>%
  mutate(subgroup=fct_relevel(subgroup,c("All", "Fatal", "ESBL", "CP")))


o_coverage_globalTop10_subgroups <- plotCoverage(obayes_raw_coverage_subgroups, obayes$locus_rank, maxRank=10, xintercept=c(5,10), cols=group_cols, col_title = "c) Subgroup")

o_coverage_globalTop10_subgroups

```

``` {r}
(o_prev_global_dist + o_prev_region_heatmap) / (o_coverage_globalTop10_subgroups + ggtitle("c) Global coverage") + ocoverage_globalTop10_globalRegional + ggtitle("d) Regional coverage") + plot_layout(guides="collect"))

ggsave("figures/Fig4_O_prevAdj_coverageRaw.pdf", width=8, height=8)
ggsave("figures/Fig4_O_prevAdj_coverageRaw.png", width=8, height=8)
```


# numbers for text - O prevalence and coverage
``` {r}
# O prevalence
obayes$global_est

obayes$region_est

# coverage
obayes_raw_coverage

# STs with O4 or O2a in Southern Asia
data_NNS_sites10 %>% filter(Region=="Southern Asia" & O_genotype=="O4") %>% group_by(ST, K_locus)%>% count()
data_NNS_sites10 %>% filter(Region=="Southern Asia" & O_genotype=="O4") %>% group_by(ST, K_locus, Site)%>% count()

data_NNS_sites10 %>% filter(Region=="Southern Asia" & O_genotype=="O2a") %>% group_by(ST, K_locus)%>% count()
data_NNS_sites10 %>% filter(Region=="Southern Asia" & O_genotype=="O2a") %>% group_by(ST, K_locus, Site)%>% count()

data_NNS_sites10 %>% filter(Region=="Southern Africa" & O_genotype=="O5") %>% group_by(ST, K_locus)%>% count()
data_NNS_sites10 %>% filter(Region=="Southern Africa" & O_genotype=="O5") %>% group_by(ST, K_locus, Site, Country)%>% count()

# top-5 coverage
obayes_raw_coverage %>% filter(rank==5)
obayes_raw_coverage_subgroups %>% filter(rank==5)
```


# Table S5 - O coverage stats for all/ESBL/CP/fatal, for global and regional
``` {r}
obayes_fatal_raw_min10perSite_coverageRegional <- getCumulativeCoverageGlobalRegional(ranks=obayes$locus_rank, bayes=obayes_fatal_raw_min10perSite, maxRank=10)

obayes_esbl_raw_min10perSite_coverageRegional <- getCumulativeCoverageGlobalRegional(ranks=obayes$locus_rank, bayes=obayes_esbl_raw_min10perSite, maxRank=10)

obayes_cp_raw_min10perSite_coverageRegional <- getCumulativeCoverageGlobalRegional(ranks=obayes$locus_rank, bayes=obayes_cp_raw_min10perSite, maxRank=10)

tableS5 <- obayes_raw_coverage %>% filter(rank <= 10) %>% mutate(cases="All") %>%
  bind_rows(obayes_fatal_raw_min10perSite_coverageRegional %>% mutate(cases="  Fatal infections")) %>%
  bind_rows(obayes_esbl_raw_min10perSite_coverageRegional %>% mutate(cases="  ESBL infections")) %>%
  bind_rows(obayes_cp_raw_min10perSite_coverageRegional %>% mutate(cases="  CP infections")) %>%
  mutate(upper=if_else(upper>1, 1, upper)) %>%
  mutate(summary=paste0(round(mean,3)*100," (",round(lower,3)*100,"-",round(upper,3)*100,")")) %>% 
  select(locus, subgroup, cases, summary) %>% 
  pivot_wider(names_from=locus, values_from=summary, id_cols=c(subgroup, cases)) %>%
  rename(Region=subgroup)

```

# add totals per subgroup
``` {r}
tableS5 <- esbl_counts %>% mutate(cases="  ESBL infections") %>%
  bind_rows(cp_counts %>% mutate(cases="  CP infections")) %>%
  bind_rows(fatal_counts %>% mutate(cases="  Fatal infections")) %>%
  bind_rows(total_counts %>% mutate(cases="All")) %>%
  full_join(tableS5, by=c("Region", "cases")) %>%
  mutate(cases=fct_relevel(cases,c("All", "  Fatal infections", "  ESBL infections", "  CP infections")))

# sort function isn't working when ordering region factor using fct_relevel
tableS5$Region <- factor(tableS5$Region, levels = c("Global", "Eastern Africa", "Southern Africa", "Western Africa", "Southern Asia"))

tableS5 <- tableS5 %>%
  arrange(Region, cases) %>%
  relocate(n, .after=cases) %>% 
  mutate(cases=if_else(cases=="All", Region, cases)) %>%
  rename(N=n) %>%
  rename(Data=cases) %>%
  ungroup %>% select(-Region)
  
write_tsv(tableS5, file="tables/TableS5_coverage.tsv")
```

# numbers for text - effect of cluster adjustment
``` {r}
kbayes_global %>% mutate(diff=mean.raw-mean.adj) %>% select(locus, mean.raw, mean.adj, diff, rank.raw, rank.adj) %>% arrange(-diff)


data_NNS_sites10 %>% filter(K_locus=="KL102") %>% group_by(Cluster, Country, ST) %>% count() %>% arrange(-n) %>% mutate(p=n/data_NNS_sites10 %>% filter(K_locus=="KL102") %>% nrow()) %>% ungroup() %>% mutate(cum=cumsum(p))

data_NNS_sites10 %>% filter(K_locus=="KL2") %>% group_by(Cluster, Country, ST) %>% count() %>% arrange(-n) %>% mutate(p=n/data_NNS_sites10 %>% filter(K_locus=="KL2") %>% nrow()) %>% ungroup() %>% mutate(cum=cumsum(p))

data_NNS_sites10 %>% filter(K_locus=="KL15") %>% group_by(Cluster, Country, ST) %>% count() %>% arrange(-n) %>% mutate(p=n/data_NNS_sites10 %>% filter(K_locus=="KL15") %>% nrow()) %>% ungroup() %>% mutate(cum=cumsum(p))


data_NNS_sites10 %>% filter(K_locus=="KL104") %>% group_by(Cluster, Country, ST) %>% count() %>% arrange(-n) %>% mutate(p=n/data_NNS_sites10 %>% filter(K_locus=="KL104") %>% nrow()) %>% ungroup() %>% mutate(cum=cumsum(p))

data_NNS_sites10 %>% filter(K_locus=="KL157") %>% group_by(Cluster, Country, ST) %>% count() %>% arrange(-n) %>% mutate(p=n/data_NNS_sites10 %>% filter(K_locus=="KL157") %>% nrow()) %>% ungroup() %>% mutate(cum=cumsum(p))

data_NNS_sites10 %>% filter(K_locus=="KL81") %>% group_by(Cluster, Country, ST) %>% count() %>% arrange(-n) %>% mutate(p=n/data_NNS_sites10 %>% filter(K_locus=="KL81") %>% nrow()) %>% ungroup() %>% mutate(cum=cumsum(p))

data_NNS_sites10 %>% filter(K_locus=="KL108") %>% group_by(Cluster, Country, ST) %>% count() %>% arrange(-n) %>% mutate(p=n/data_NNS_sites10 %>% filter(K_locus=="KL108") %>% nrow()) %>% ungroup() %>% mutate(cum=cumsum(p))

data_NNS_sites10 %>% filter(K_locus=="KL149") %>% group_by(Cluster, Country, ST) %>% count() %>% arrange(-n) %>% mutate(p=n/data_NNS_sites10 %>% filter(K_locus=="KL149") %>% nrow()) %>% ungroup() %>% mutate(cum=cumsum(p))

# how do these compare to those added to KL set 2 to get good region coverage? - only KL81
k_rank_region8 %>% left_join(kbayes$locus, by="locus") %>% filter(rank.y>20)
```




# Leave One out (LOO)
## Sensitivity analysis - O type, Bayesian estimate, adjusted
``` {r}
loo <- obayes$global_est %>% mutate(Study="None")

loo <- read_csv("outputs_LOO/O_Full_min10_adj_28_LOO_AKU_global_estimates.csv") %>% 
  mutate(Study="AKU") %>% 
  arrange(-mean) %>%
  mutate(rank = min_rank(desc(mean))) %>% 
  bind_rows(loo)

loo <- read_csv("outputs_LOO/O_Full_min10_adj_28_LOO_BabyGERMS_global_estimates.csv") %>% 
  mutate(Study="BabyGERMS") %>% 
  arrange(-mean) %>%
  mutate(rank = min_rank(desc(mean))) %>% 
  bind_rows(loo)

loo <- read_csv("outputs_LOO/O_Full_min10_adj_28_LOO_BARNARDS_global_estimates.csv") %>% 
  mutate(Study="BARNARDS") %>% 
  arrange(-mean) %>%
  mutate(rank = min_rank(desc(mean))) %>% 
  bind_rows(loo)

loo <- read_csv("outputs_LOO/O_Full_min10_adj_28_LOO_Botswana_global_estimates.csv") %>% 
  mutate(Study="Botswana") %>% 
  arrange(-mean) %>%
  mutate(rank = min_rank(desc(mean))) %>% 
  bind_rows(loo)

loo <- read_csv("outputs_LOO/O_Full_min10_adj_28_LOO_CHRF_global_estimates.csv") %>% 
  mutate(Study="CHRF") %>% 
  arrange(-mean) %>%
  mutate(rank = min_rank(desc(mean))) %>% 
  bind_rows(loo)

loo <- read_csv("outputs_LOO/O_Full_min10_adj_28_LOO_AIIMS_global_estimates.csv") %>% 
  mutate(Study="DH") %>% 
  arrange(-mean) %>%
  mutate(rank = min_rank(desc(mean))) %>% 
  bind_rows(loo)

loo <- read_csv("outputs_LOO/O_Full_min10_adj_28_LOO_GBS_global_estimates.csv") %>% 
  mutate(Study="GBSCOP") %>% 
  arrange(-mean) %>%
  mutate(rank = min_rank(desc(mean))) %>% 
  bind_rows(loo)

loo <- read_csv("outputs_LOO/O_Full_min10_adj_28_LOO_Kilifi_global_estimates.csv") %>% 
  mutate(Study="Kilifi") %>% 
  arrange(-mean) %>%
  mutate(rank = min_rank(desc(mean))) %>% 
  bind_rows(loo)

loo <- read_csv("outputs_LOO/O_Full_min10_adj_28_LOO_MBIRA_global_estimates.csv") %>% 
  mutate(Study="MBIRA") %>% 
  arrange(-mean) %>%
  mutate(rank = min_rank(desc(mean))) %>% 
  bind_rows(loo)

loo <- read_csv("outputs_LOO/O_Full_min10_adj_28_LOO_MLW_global_estimates.csv") %>% 
  mutate(Study="MLW") %>% 
  arrange(-mean) %>%
  mutate(rank = min_rank(desc(mean))) %>% 
  bind_rows(loo)

loo <- read_csv("outputs_LOO/O_Full_min10_adj_28_LOO_NeoBAC_global_estimates.csv") %>% 
  mutate(Study="NeoBAC") %>% 
  arrange(-mean) %>%
  mutate(rank = min_rank(desc(mean))) %>% 
  bind_rows(loo)

loo <- read_csv("outputs_LOO/O_Full_min10_adj_28_LOO_NeoOBS_global_estimates.csv") %>% 
  mutate(Study="NeoOBS-India") %>% 
  arrange(-mean) %>%
  mutate(rank = min_rank(desc(mean))) %>% 
  bind_rows(loo)

loo_O <- read_csv("outputs_LOO/O_Full_min10_adj_28_LOO_SPINZ_global_estimates.csv") %>% 
  mutate(Study="SPINZ") %>% 
  arrange(-mean) %>%
  mutate(rank = min_rank(desc(mean))) %>% 
  bind_rows(loo) %>%
  mutate(locus=replace(locus, locus=="O2a.v1", "O2a")) %>%
  mutate(locus=replace(locus, locus=="O2afg.v2", "O2afg"))

```

# Bayes global sensitivity analysis, top20 in any, print rank  - O type
``` {r}
loo_O_plot <- loo_O %>% 
  filter(rank<=9) %>%
  ggplot(aes(y=locus, x=Study, fill=factor(rank))) +
  geom_tile() + 
  geom_text(aes(y=locus, x=Study, label=round(rank)), size=4) +
  scale_y_discrete(limits=rev(obayes$locus_rank$locus[1:9])) + 
  scale_x_discrete(limits=rev(unique(loo_O$Study))) + # keep the order as per tibble, starting with 'None'
  #scale_fill_gradient("Global\nprevalence (%)", low = "white", high = "#081d58")
  scale_fill_manual(values = c(rev(brewer.pal(5, "Reds")), rev(brewer.pal(6, "Blues")[-1]))) +
  theme_bw() + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 10, 
                                   colour = "black"), 
        axis.title = element_text(size = 10, colour = "black"),
        axis.text.y = element_text(size = 10, colour = "black"),
        plot.title = element_text(hjust=0.5),
        legend.position = "right") +
  labs(y="", x="Excluded study", title="Sensitivity analysis - O types", fill="Rank")
```


## Sensitivity analysis - K locus, Bayesian estimate, adjusted
``` {r}
loo <- kbayes$global_est %>% mutate(Study="None")

loo <- read_csv("outputs_LOO/K_Full_min10_adj_28_LOO_AKU_global_estimates.csv") %>% 
  mutate(Study="AKU") %>% 
  arrange(-mean) %>%
  mutate(rank = min_rank(desc(mean))) %>% 
  bind_rows(loo)

loo <- read_csv("outputs_LOO/K_Full_min10_adj_28_LOO_BabyGERMS_global_estimates.csv") %>% 
  mutate(Study="BabyGERMS") %>% 
  arrange(-mean) %>%
  mutate(rank = min_rank(desc(mean))) %>% 
  bind_rows(loo)

loo <- read_csv("outputs_LOO/K_Full_min10_adj_28_LOO_BARNARDS_global_estimates.csv") %>% 
  mutate(Study="BARNARDS") %>% 
  arrange(-mean) %>%
  mutate(rank = min_rank(desc(mean))) %>% 
  bind_rows(loo)

loo <- read_csv("outputs_LOO/K_Full_min10_adj_28_LOO_Botswana_global_estimates.csv") %>% 
  mutate(Study="Botswana") %>% 
  arrange(-mean) %>%
  mutate(rank = min_rank(desc(mean))) %>% 
  bind_rows(loo)

loo <- read_csv("outputs_LOO/K_Full_min10_adj_28_LOO_CHRF_global_estimates.csv") %>% 
  mutate(Study="CHRF") %>% 
  arrange(-mean) %>%
  mutate(rank = min_rank(desc(mean))) %>% 
  bind_rows(loo)

loo <- read_csv("outputs_LOO/K_Full_min10_adj_28_LOO_AIIMS_global_estimates.csv") %>% 
  mutate(Study="DH") %>% 
  arrange(-mean) %>%
  mutate(rank = min_rank(desc(mean))) %>% 
  bind_rows(loo)

loo <- read_csv("outputs_LOO/K_Full_min10_adj_28_LOO_GBS_global_estimates.csv") %>% 
  mutate(Study="GBSCOP") %>% 
  arrange(-mean) %>%
  mutate(rank = min_rank(desc(mean))) %>% 
  bind_rows(loo)

loo <- read_csv("outputs_LOO/K_Full_min10_adj_28_LOO_Kilifi_global_estimates.csv") %>% 
  mutate(Study="Kilifi") %>% 
  arrange(-mean) %>%
  mutate(rank = min_rank(desc(mean))) %>% 
  bind_rows(loo)

loo <- read_csv("outputs_LOO/K_Full_min10_adj_28_LOO_MBIRA_global_estimates.csv") %>% 
  mutate(Study="MBIRA") %>% 
  arrange(-mean) %>%
  mutate(rank = min_rank(desc(mean))) %>% 
  bind_rows(loo)

loo <- read_csv("outputs_LOO/K_Full_min10_adj_28_LOO_MLW_global_estimates.csv") %>% 
  mutate(Study="MLW") %>% 
  arrange(-mean) %>%
  mutate(rank = min_rank(desc(mean))) %>% 
  bind_rows(loo)

loo <- read_csv("outputs_LOO/K_Full_min10_adj_28_LOO_NeoBAC_global_estimates.csv") %>% 
  mutate(Study="NeoBAC") %>% 
  arrange(-mean) %>%
  mutate(rank = min_rank(desc(mean))) %>% 
  bind_rows(loo)

loo <- read_csv("outputs_LOO/K_Full_min10_adj_28_LOO_NeoOBS_global_estimates.csv") %>% 
  mutate(Study="NeoOBS-India") %>% 
  arrange(-mean) %>%
  mutate(rank = min_rank(desc(mean))) %>% 
  bind_rows(loo)

loo <- read_csv("outputs_LOO/K_Full_min10_adj_28_LOO_SPINZ_global_estimates.csv") %>% 
  mutate(Study="SPINZ") %>% 
  arrange(-mean) %>%
  mutate(rank = min_rank(desc(mean))) %>% 
  bind_rows(loo) 

```


# sensitivity analysis for K, top20 in any, print rank
``` {r}
top20_sens <- loo %>% filter(rank<=20) %>% pull(locus) %>% unique()

loo_k_ranks <- loo %>% 
  filter(rank<=20) %>%
  ggplot(aes(y=locus, x=Study, fill=factor(rank))) +
  geom_tile() + 
  geom_text(aes(y=locus, x=Study, label=round(rank)), size=4) +
  scale_y_discrete(limits=rev(kbayes$locus_rank$locus[kbayes$locus_rank$locus %in% top20_sens])) + 
  scale_x_discrete(limits=rev(unique(loo$Study))) + # keep the order as per tibble, starting with 'None'
  #scale_fill_gradient("Global\nprevalence (%)", low = "white", high = "#081d58")
  scale_fill_manual(values = c(rev(brewer.pal(5, "Reds")), rev(brewer.pal(6, "Purples")[-1]), rev(brewer.pal(6, "Blues")[-1]), rev(brewer.pal(5, "Greens")))) +
  theme_bw() + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 10, 
                                   colour = "black"), 
        axis.title = element_text(size = 10, colour = "black"),
        axis.text.y = element_text(size = 10, colour = "black"),
        plot.title = element_text(hjust=0.5),
        legend.position = "right") +
  labs(y="", x="Excluded study", title="Sensitivity analysis", fill="Rank") +
  geom_hline(yintercept=length(top20_sens)+0.5-5) +
  geom_hline(yintercept=length(top20_sens)+0.5-10) +
  geom_hline(yintercept=length(top20_sens)+0.5-15) +
  geom_hline(yintercept=length(top20_sens)+0.5-20)

```


# LOO - K coverage 
``` {r}
studies <- unique(data$Study)
studies <- studies[-c(8,12)]
studies <- c(studies, c("AIIMS", "NeoOBS"))

loo_k_coverage <- tibble(
    rank = integer(0),
    mean = double(0),
    median = double(0),
    lower = double(0),
    upper = double(0),
    locus = character(0),
    subgroup = character(0),
    Study = character(0)
  )

for (study in studies) {

# read raw Bayesian estimates for K
loo_kbayes_raw <- parseModelledEstimates(global_post=paste0("outputs_LOO/posterior/K_Full_min10_raw_28_LOO_",study,"_posterior_global.csv.gz"), region_post=paste0("outputs_LOO/posterior/K_Full_min10_raw_28_LOO_",study,"_posterior_subgroup.csv.gz"))

this_coverage <- getCumulativeCoverageGlobalRegional(loo_kbayes_raw, kbayes$locus_rank) %>%
  mutate(subgroup=fct_relevel(subgroup,c("Global", "Southern Asia", "Eastern Africa", "Southern Africa", "Western Africa"))) %>%
  mutate(Study=study)

loo_k_coverage <- bind_rows(loo_k_coverage, this_coverage)
}

loo_k_coverage_plot <- loo_k_coverage %>% 
  mutate(subgroup=fct_relevel(subgroup,rev(c("Global", "Southern Asia", "Eastern Africa", "Southern Africa", "Western Africa")))) %>%
  bind_rows(kbayes_raw_coverage %>% mutate(Study="None")) %>% 
  filter(rank==20) %>% 
  mutate(Study=if_else(Study=="NeoOBS", "NeoOBS-India", Study)) %>%
  mutate(Study=if_else(Study=="AIIMS", "DH", Study)) %>%
  mutate(Study=if_else(Study=="GBS", "GBSCOP", Study)) %>%
  ggplot(aes(x=Study, y=subgroup, fill=mean)) + 
    geom_tile() + 
    geom_text(aes(y=subgroup, x=Study, label=round(100*mean, 2)), size=3) +
    scale_x_discrete(limits=rev(unique(loo$Study))) + 
    scale_fill_gradient(low="white", high="grey") +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 10, 
                                     colour = "black"), 
          axis.title = element_text(size = 10, colour = "black"),
          axis.text.y = element_text(size = 10, colour = "black"),
          plot.title = element_text(hjust=0.5),
          legend.position = "right") +
    labs(y="", x="Excluded study", fill="Coverage")
```

``` {r}
loo_k_ranks / loo_k_coverage_plot + plot_layout(heights=c(4,1), axes="collect")

ggsave(file="figures/FigS11_LOO_BayesGlobal_Klocus.pdf", width=9, height=11)
ggsave(file="figures/FigS11_LOO_BayesGlobal_Klocus.png", width=9, height=11)

```

``` {r}
loo_o_coverage <- tibble(
    rank = integer(0),
    mean = double(0),
    median = double(0),
    lower = double(0),
    upper = double(0),
    locus = character(0),
    subgroup = character(0),
    Study = character(0)
  )

for (study in studies) {

# read raw Bayesian estimates for K
loo_obayes_raw <- parseModelledEstimates(global_post=paste0("outputs_LOO/posterior/O_Full_min10_raw_28_LOO_",study,"_posterior_global.csv.gz"), region_post=paste0("outputs_LOO/posterior/O_Full_min10_raw_28_LOO_",study,"_posterior_subgroup.csv.gz"), fixOnames = T)

this_coverage <- getCumulativeCoverageGlobalRegional(loo_obayes_raw, obayes$locus_rank) %>%
  mutate(subgroup=fct_relevel(subgroup,c("Global", "Southern Asia", "Eastern Africa", "Southern Africa", "Western Africa"))) %>%
  mutate(Study=study)

loo_o_coverage <- bind_rows(loo_o_coverage, this_coverage)
}

```

``` {r}
loo_o_coverage_plot <- loo_o_coverage %>% 
  mutate(subgroup=fct_relevel(subgroup,rev(c("Global", "Southern Asia", "Eastern Africa", "Southern Africa", "Western Africa")))) %>%
  bind_rows(obayes_raw_coverage %>% mutate(Study="None")) %>% 
  filter(rank==5) %>% 
  mutate(Study=if_else(Study=="NeoOBS", "NeoOBS-India", Study)) %>%
  mutate(Study=if_else(Study=="AIIMS", "DH", Study)) %>%
  mutate(Study=if_else(Study=="GBS", "GBSCOP", Study)) %>%
  ggplot(aes(x=Study, y=subgroup, fill=mean)) + 
    geom_tile() + 
    geom_text(aes(y=subgroup, x=Study, label=round(100*mean, 2)), size=3) +
    scale_x_discrete(limits=rev(unique(loo$Study))) + 
    scale_fill_gradient(low="lightgrey", high="darkgrey") +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 10, 
                                     colour = "black"), 
          axis.title = element_text(size = 10, colour = "black"),
          axis.text.y = element_text(size = 10, colour = "black"),
          plot.title = element_text(hjust=0.5),
          legend.position = "right") +
    labs(y="", x="Excluded study", fill="Coverage")
```

``` {r}
loo_O_plot / loo_o_coverage_plot + plot_layout(heights=c(2,1), axes="collect")

ggsave(file="figures/FigS12_LOO_BayesGlobal_Olocus.pdf", width=9, height=9)
ggsave(file="figures/FigS12_LOO_BayesGlobal_Olocus.png", width=9, height=9)

```

# EFFECT OF TEMPORAL THRESHOLD FOR CLUSTERING ON MODELLED ESTIMATES 

## compare global prevalence distributions using counts cluster-adjusted using 28 vs 365-day threshold
``` {r}
# read Bayesian estimates for K adjusted using 365 days
kbayes_365 <- parseModelledEstimates(global_post="outputs_365day/K_Full_min10_adj_365_posterior_global.csv.gz", region_post="outputs_paper/K_Full_min10_adj_28_posterior_subgroup.csv.gz")

# plot raw vs adjusted distributions, overlaid - for fig S15
k_dist_28_365 <- comparative_locus_ridgesplot(posterior1=kbayes$global_post,
                             posterior2=kbayes_365$global_post,
                             ranks=kbayes$locus_rank, 
                             lines_every=10, xlim=c(0,12), xbreaks=seq(0,12,1),
                             maxRank=30, type1="28 days", type2="365 days", legend_title="Cluster threshold", scale=2, title="e) Modelled K estimates - posterior")

# read Bayesian estimates for O adjusted using 365 days
obayes_365 <- parseModelledEstimates(global_post="outputs_365day/O_Full_min10_adj_365_posterior_global.csv.gz", region_post="outputs_365day/O_Full_min10_adj_365_posterior_subgroup.csv.gz", fixOnames = T)

# plot raw vs adjusted distributions, overlaid - for fig S15
o_dist_28_365 <- comparative_locus_ridgesplot(posterior1=obayes$global_post,
                             posterior2=obayes_365$global_post,
                             ranks=obayes$locus_rank, 
                             lines_every=5, xlim=c(0,30), xbreaks=seq(0,30,2),
                             maxRank=15, type1="28 days", type2="365 days", legend_title="Cluster threshold", scale=2, title="f) Modelled O estimates - posterior")
```

## Scatter plots for K mean and rank
``` {r}
adj_28_vs_365 <- full_join(kbayes$global_est %>% arrange(-mean) %>% ungroup %>% mutate(rank=row_number()), 
          kbayes_365$global_est %>% arrange(-mean) %>% ungroup() %>% mutate(rank=row_number()),
          by="locus", suffix=c(".28", ".365")) 

timeThreshold_estimates_adj <- adj_28_vs_365 %>%
  ggplot(aes(x=mean.28, y=mean.365)) + 
  geom_abline(intercept=0, slope=1, col="grey") +
  geom_point() + theme_bw() + 
  labs(x="28-day threshold", y="365-day threshold", title="c) Mean K estimates")

timeThreshold_ranks_adj <- adj_28_vs_365 %>%
  ggplot(aes(x=rank.28, y=rank.365)) + 
  geom_abline(intercept=0, slope=1, col="grey") +
  geom_point() + theme_bw()  + 
  labs(x="28-day threshold", y="365-day threshold", title="a) Modelled K ranks")

timeThreshold_estimates_adj + timeThreshold_ranks_adj

```

## Scatter plots for O mean and rank
``` {r}
adj_28_vs_365_o <- full_join(obayes$global_est %>% arrange(-mean) %>% ungroup %>% mutate(rank=row_number()), 
          obayes_365$global_est %>% arrange(-mean) %>% ungroup() %>% mutate(rank=row_number()),
          by="locus", suffix=c(".28", ".365")) 

timeThreshold_estimates_adj_o <- adj_28_vs_365_o %>%
  ggplot(aes(x=mean.28, y=mean.365)) + 
  geom_abline(intercept=0, slope=1, col="grey") +
  geom_point() + theme_bw() + 
  labs(x="28-day threshold", y="365-day threshold", title="d) Mean O estimates")

timeThreshold_ranks_adj_o <- adj_28_vs_365_o %>%
  ggplot(aes(x=rank.28, y=rank.365)) + 
  geom_abline(intercept=0, slope=1, col="grey") +
  geom_point() + theme_bw()  + 
  labs(x="28-day threshold", y="365-day threshold", title="b) Modelled O ranks")

timeThreshold_estimates_adj_o + timeThreshold_ranks_adj_o
```

## Figure S15
``` {r}
(timeThreshold_ranks_adj + timeThreshold_ranks_adj_o) / (timeThreshold_estimates_adj + timeThreshold_estimates_adj_o) / (k_dist_28_365 + o_dist_28_365 + plot_layout(guides="collect")) + plot_layout(heights=c(1,1,2)) & theme(legend.position='bottom')

ggsave("figures/FigS15_temporalThresholdModelled.pdf", width=8, height=10)
ggsave("figures/FigS15_temporalThresholdModelled.png", width=8, height=10)
```
